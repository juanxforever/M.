<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>CarPlayer - Tu Reproductor</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

<style>
/* TUS ESTILOS ORIGINALES COMPLETOS */
@media (orientation: portrait){
  body::before{
    content:"GIRA EL M√ìVIL";
    position:fixed; inset:0; background:#000; color:#fff; z-index:9999;
    display:flex; align-items:center; justify-content:center; font-size:10vw;
  }
}
:root{
  --accent:#000;
  --bg:#000;
  --btn:#222;
  --text:#fff;
  --panel-bg:#111;
}
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:system-ui,Arial;
  color:var(--text);
}
body{
  background:var(--bg);
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#top{
  flex:1;
  display:flex;
  gap:.5rem;
  padding:.5rem;
  min-height:0;
}
.panel{
  flex:1;
  display:flex;
  flex-direction:column;
  background:var(--panel-bg);
  border-radius:1vh;
  overflow:hidden;
  min-height:0;
  position:relative;
}
.panel h3{
  display: none;
}
video{
  width:100%;
  flex:1;
  background:#000;
  outline:0;
  min-height:0;
  object-fit: cover;
  transition: none !important;
}
#center{
  background:#0005;
  border-radius:90 h;
  padding:1vh;
  display:flex;
  flex-direction:column;
  gap:1vh;
  min-width:36vh;
  overflow-y:auto;
  flex: 0 0 40%;
  overflow-x: hidden;
}
.track{
  display:flex;
  align-items:center;
  gap:1vh;
  padding:1vh;
  background:var(--btn);
  border-radius:1vh;
  cursor:pointer;
  height:10vh;
  flex-shrink:0;
  max-width: 100%;
  box-sizing: border-box;
}
.track img{
  height:100%;
  aspect-ratio:16/9;
  object-fit:cover;
  border-radius:1vh;
  max-width: 20%;
  flex-shrink: 0;
}
.track-info{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:0.5vh;
  min-width: 0;
  overflow: hidden;
}
.track-title{
  font-size:3.5vh;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width: 100%;
}
.track-genre{
  font-size:2.5vh;
  color:var(--accent);
  opacity:0.8;
}
.track.active{
  background:var(--accent);
  color:#fff;
  border: 3px solid #fff;
  box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
  transform: scale(1.02);
  transition: all 0.3s ease;
}
.track.active .track-genre{
  color:#fff;
  opacity:1;
  font-weight: bold;
}
.track.active .track-title{
  font-weight: bold;
  text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
}
#bottom{
  display:flex;
  align-items:center;
  gap:1vh;
  padding:1vh;
  background:#0005;
  flex-shrink:0;
}
button{
  flex:1;
  height:12vh;
  border:none;
  border-radius:1.5vh;
  background:var(--btn);
  color:var(--text);
  font-weight:700;
  font-size:5vh;
  cursor:pointer;
  transition: background 0.3s;
}
button:hover{
  background:var(--accent);
  color:var(--text);
}
button:disabled{
  opacity:.3;
}
#play {
  background:var(--btn);
  color:var(--text);
}
#play:hover {
  background:var(--accent);
  color:var(--text);
}
#progress{
  height:3vh;
  background:#444;
  border-radius:1.5vh;
  cursor:pointer;
  margin:0 1vh;
  flex-shrink:0;
}
#bar{
  height:100%;
  background:var(--accent);
  border-radius:1.5vh;
  width:0%;
}
#safeDrive{
  display:flex;
  align-items:center;
  gap:1vh;
  padding:1vh;
  font-size:3vh;
  flex-shrink:0;
}
#safeDrive input{
  width:4vh;
  height:4vh;
}
#filters{
  display:flex;
  gap:1vh;
  padding:1vh;
  background:#0005;
  flex-wrap:wrap;
  flex-shrink:0;
  max-height:15vh;
  overflow-y:auto;
  overflow-x: hidden;
}
.filter-btn{
  background:var(--btn);
  color:var(--text);
  border:none;
  padding:1vh 2vh;
  border-radius:1vh;
  cursor:pointer;
  font-size:2.5vh;
  transition:all 0.3s;
  white-space:nowrap;
}
.filter-btn.active{
  background:var(--accent);
  color:var(--text);
}
.filter-btn:hover{
  background:var(--accent);
  color:var(--text);
}
.audio-only #center {
  flex: 1;
}
.audio-only .panel:first-child {
  display: none;
}
#fullscreen-container {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: #000;
  z-index: 10000;
  flex-direction: column;
}
#fullscreen-container.active {
  display: flex;
}
#fullscreen-controls {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 10px;
  z-index: 10001;
  background: rgba(0,0,0,0.8);
  padding: 10px 15px;
  border-radius: 10px;
  border: 1px solid var(--accent);
  opacity: 1;
  transition: opacity 0s ease-in-out 0s;
}
#fullscreen-container.active #fullscreen-controls {
  opacity: 1;
  transition: opacity 0s ease-in-out 2s;
}
#fullscreen-container.active:hover #fullscreen-controls,
#fullscreen-container.active #fullscreen-controls:hover {
  opacity: 1;
  transition: opacity 0s ease-in-out;
}
#fullscreen-controls button {
  background: var(--accent);
  color: var(--text);
  border: none;
  padding: 8px 12px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  min-width: 40px;
}
#fullscreen-controls button:hover {
  background: #333;
}
#loading {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.8);
  color: var(--white);
  padding: 20px;
  border-radius: 10px;
  z-index: 10002;
  display: none;
}
#center::-webkit-scrollbar {
  width: 8px;
}
#center::-webkit-scrollbar-track {
  background: #222;
  border-radius: 4px;
}
#center::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 4px;
}
#center::-webkit-scrollbar-thumb:hover {
  background: #333;
}
</style>
</head>
<body>

<div id="top">
  <div class="panel">
    <h3>VIDEO</h3>
    <video id="vP" muted playsinline></video>
  </div>
  <div id="center"></div>
</div>

<div id="filters">
  <button class="filter-btn active" data-genre="all">Todos</button>
</div>

<div id="progress"><div id="bar"></div></div>
<div id="bottom">
  <button id="prev">‚èÆ</button>
  <button id="play">‚ñ∂</button>
  <button id="next">‚è≠</button>
  <button id="toggleMute">üîá</button>
  <button id="fullscreen">‚õ∂</button>
</div>
<div id="safeDrive">
  <input type="checkbox" id="driving">
  <label for="driving">Conduciendo (solo audio)</label>
</div>

<!-- SOLO CONTROLES - EL VIDEO SE MUEVE AQU√ç EN FULLSCREEN -->
<div id="fullscreen-container">
  <div id="fullscreen-controls">
    <button id="fs-prev">‚èÆ</button>
    <button id="fs-play">‚ñ∂</button>
    <button id="fs-next">‚è≠</button>
    <button id="fs-mute">üîá</button>
    <button id="fs-exit">Salir</button>
  </div>
</div>


<!-- BLOQUEO REMOTO DEFINITIVO -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

// --- Configuraci√≥n Firebase ---
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_AUTH_DOMAIN",
  databaseURL: "https://music-76fda-default-rtdb.firebaseio.com/",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_BUCKET.appspot.com",
  messagingSenderId: "TU_SENDER_ID",
  appId: "TU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const bloqueoRef = ref(db, 'bloqueoApp');

// --- Crear overlay permanente ---
let layer = document.getElementById('blockLayer');
if(!layer){
  layer = document.createElement('div');
  layer.id = 'blockLayer';
  layer.style.cssText = `
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.97);
    color: #fff;
    font-size: 2em;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    z-index: 999999;
    animation: fadeIn 1s ease-in-out;
  `;
  layer.innerHTML = `<span id="blockMessage">üö´ App bloqueada<br>Estamos en mantenimiento   gracias por su comprensi√≥n  </span>`;
  document.body.appendChild(layer);
}

// --- Animaciones ---
const style = document.createElement('style');
style.innerHTML = `
@keyframes fadeIn {
  0% {opacity: 0; transform: scale(0.8);}
  100% {opacity: 1; transform: scale(1);}
}
#blockMessage {
  text-align: center;
  animation: pulse 1.5s infinite alternate;
}
@keyframes pulse {
  0% {transform: scale(1); color: #ff5555;}
  50% {transform: scale(1.1); color: #ff2222;}
  100% {transform: scale(1); color: #ff5555;}
}
`;
document.head.appendChild(style);

// --- Funciones de bloqueo/desbloqueo ---
function bloquearApp() {
  layer.style.display = 'flex';
  // Pausar audio y video
  const medias = document.querySelectorAll('audio, video');
  medias.forEach(m => {
    m.pause();
    // Evitar que el usuario reproduzca manualmente
    const blockPlay = () => m.pause();
    m.addEventListener('play', blockPlay);
    // Guardar listener para remover luego
    m._blockPlayListener = blockPlay;
  });
}

function desbloquearApp() {
  layer.style.display = 'none';
  const medias = document.querySelectorAll('audio, video');
  medias.forEach(m => {
    if(m._blockPlayListener) m.removeEventListener('play', m._blockPlayListener);
  });
}

// --- Escucha remota en tiempo real ---
onValue(bloqueoRef, snapshot => {
  const value = snapshot.val();
  if(value === true) bloquearApp();
  else desbloquearApp();
});

// --- Seguridad extra: Rechequeo cada 1s ---
setInterval(() => {
  const value = document.querySelector('#blockLayer').style.display === 'flex';
  if(value){
    const medias = document.querySelectorAll('audio, video');
    medias.forEach(m => m.pause());
  }
}, 1000);
</script>
<!-- FIN BLOQUEO REMOTO DEFINITIVO -->


<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CarPlayer + Usuarios IP/Provincia/Distrito</title>
  <style>
    body{margin:0;background:#121212;color:#fff;font-family:system-ui;text-align:center}
    h1{color:#00e5ff;text-shadow:0 0 15px #00e5ff;margin:20px 0 10px}

    /* Control remoto */
    .remote-container{margin-bottom:20px}
    .switch{position:relative;display:inline-block;width:80px;height:40px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#333;transition:.4s;border-radius:50px}
    .slider::before{content:"";position:absolute;height:32px;width:32px;left:4px;bottom:4px;background:#fff;border-radius:50%;transition:.4s}
    input:checked + .slider{background:linear-gradient(45deg,#00ff99,#00e5ff);box-shadow:0 0 20px #00ff99,0 0 40px #00e5ff}
    input:checked + .slider::before{transform:translateX(40px)}
    .status-text{display:block;margin-top:10px;font-size:1.1em;color:#ff5555;transition:color .4s}
    input:checked ~ .status-text{color:#00ff99}

    /* Panel compacto */
    #userPanel{position:fixed;top:10px;right:10px;width:220px;background:rgba(0,0,0,.95);border:1px solid #00e5ff;border-radius:8px;padding:8px;font-size:12px;z-index:9999;display:none}
    #userPanel.active{display:block}
    #togglePanel{position:fixed;top:10px;right:10px;z-index:10000;background:#00e5ff;color:#000;border:none;padding:6px 10px;border-radius:6px;font-weight:bold;cursor:pointer}
    #userCount{color:#00ff99;margin-bottom:6px;text-align:center;font-size:13px}
    .userLine{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #222;font-size:11px}
    .userLine:last-child{border:none}
    .userIp{color:#ffc107}
    .userProv{color:#0ff}
    .userDist{color:#9f9}
  </style>
</head>
<body>
    
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    databaseURL: "https://music-76fda-default-rtdb.firebaseio.com/",
    projectId: "TU_PROJECT_ID",
    storageBucket: "TU_BUCKET.appspot.com",
    messagingSenderId: "TU_SENDER_ID",
    appId: "TU_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // --- Control Remoto (SIN CAMBIOS) ---
  const bloqueoRef = ref(db, 'bloqueoApp');
  const toggle = document.getElementById('bloqueoToggle');
  const statusText = document.getElementById('statusText');

  onValue(bloqueoRef, snapshot => {
    toggle.checked = snapshot.val() === true;
    statusText.innerText = toggle.checked ? 'Estado: Bloqueado' : 'Estado: Desbloqueado';
  });

  toggle.addEventListener('change', () => set(bloqueoRef, toggle.checked));

  // --- Panel Arequipa Ubicaci√≥n (AHORA SIN TARJETAS) ---
  const usersRef = ref(db, 'usuariosActivos');
  const userCount = document.getElementById('userCount');
  const usersContainer = document.getElementById('usersContainer');

  const uid = localStorage.getItem('uid') || push(usersRef).key;
  localStorage.setItem('uid', uid);

  async function getIpInfo() {
    try {
      const ipRes = await fetch('https://api.ipify.org?format=json');
      const {ip} = await ipRes.json();
      const geoRes = await fetch(`https://ipapi.co/${ip}/json/`);
      const geo = await geoRes.json();
      return {
        ip,
        country: geo.country_name || 'Per√∫',
        city: geo.city || 'Arequipa',
        region: geo.region || 'Arequipa',
        district: geo.postal || 'Cercado'
      };
    } catch {
      return {ip: 'n/a', country: 'Per√∫', city: 'Arequipa', region: 'Arequipa', district: 'Cercado'};
    }
  }

  async function heartbeat() {
    const loc = await getIpInfo();
    set(ref(db, `usuariosActivos/${uid}`), {
      nombre: 'Usuario ' + uid.substr(-4),
      lastSeen: serverTimestamp(),
      ip: loc.ip,
      country: loc.country,
      city: loc.city,
      region: loc.region,
      district: loc.district
    });
  }

  heartbeat();
  setInterval(heartbeat, 30000);

  setInterval(() => {
    onValue(usersRef, snap => {
      const now = Date.now();
      snap.forEach(child => {
        const val = child.val();
        if (val.lastSeen && (now - val.lastSeen) > 120000) remove(child.ref);
      });
    }, { onlyOnce: true });
  }, 60000);

  onValue(usersRef, snapshot => {
    usersContainer.innerHTML = '';
    userCount.textContent = `Usuarios activos: ${snapshot.size}`;
    let num = 1;
    snapshot.forEach(child => {
      const u = child.val();
      const div = document.createElement('div');
      div.className = 'userLine';
      div.innerHTML = `
        <span>${num}. ${u.nombre}</span>
        <span>
          <span class="userIp">${u.ip}</span> -
          <span class="userProv">${u.region}</span> -
          <span class="userDist">${u.district}</span>
        </span>
      `;
      usersContainer.appendChild(div);
      num++;
    });
  });
</script>

<div id="loading">Cargando m√∫sica...</div>

<script>
// SISTEMA DE CACHE MEJORADO
const DataCache = {
    set: (key, data) => {
        try {
            localStorage.setItem('cache_' + key, JSON.stringify({
                data: data,
                timestamp: Date.now()
            }));
        } catch(e) {
            console.log('Cache lleno, limpiando...');
            localStorage.clear();
        }
    },
    
    get: (key, maxAge = 3600000) => { // 1 hora por defecto
        const cached = localStorage.getItem('cache_' + key);
        if(!cached) return null;
        
        const {data, timestamp} = JSON.parse(cached);
        if(Date.now() - timestamp > maxAge) {
            localStorage.removeItem('cache_' + key);
            return null;
        }
        return data;
    },
    
    clear: (key) => {
        localStorage.removeItem('cache_' + key);
    }
};

// VARIABLES GLOBALES
const vP = document.getElementById('vP');
const bar = document.getElementById('bar');
const center = document.getElementById('center');
const drivingChk = document.getElementById('driving');
const fullscreenContainer = document.getElementById('fullscreen-container');
const filtersContainer = document.getElementById('filters');
const loadingIndicator = document.getElementById('loading');

let PLAYLIST = [];
let FILTERED_PLAYLIST = [];
let idx = parseInt(localStorage.getItem('carIdx') || 0);
let isMuted = localStorage.getItem('carMuted') === 'true';
let isFullscreen = false;
let currentGenre = 'all';
let controlsTimeout;
let isSwitching = false;

// LISTA DE CANCIONES OPTIMIZADA
const GENRE_FOLDERS = {
  'Latinoamericana': [{ name: 'Latinoamericana', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Aya.c/refs/heads/main/jsskkkk.json' }],
  '„Åä„Çì„Åå„Åè': [{ name: 'Èü≥Ê•Ω', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Jp.n/refs/heads/main/jpn.json' }],
  'Baladas': [{ name: 'Baladas de ayer y Hoy', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Bl./refs/heads/main/bsss.json' }],
  'Folclore': [{ name: 'Ayllus', url: 'https://archive.org/download/xd_20251013/jssk.json' }],
  'Pop': [{ name: 'Divas', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Dip.o.p/refs/heads/main/jsskk.json' }],
  'Grupero': [{ name: 'Cumbias sure√±as', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Grp/refs/heads/main/jsskkk.json' }],
  'Rock en Espa√±ol': [{ name: 'Cl√°sicos del Rock', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/rr/refs/heads/main/rc.json' }],
  'Bachata': [{ name: 'Bachata', url: 'https://archive.org/download/vvvvvvvx/Bchvvc.json' }],
  'tecno': [{ name: 'Electr√≥nica Teckno ', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Tcno/refs/heads/main/TcElec.json' }],
  'Salsa': [{ name: 'Cl√°sica y de oro', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Ccc/refs/heads/main/Sssss.json' }],
  'Boleros': [{ name: 'Cantineros', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Bo../refs/heads/main/Bol..json' }],
  'Rock en Ingles': [{ name: '80s-90s', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Ringles/refs/heads/main/Ringles.json' }],
  'cumbias': [{ name: 'Cumbias de ayer y hoy', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/q./refs/heads/main/q...json' }],
  'Criolla': [{ name: 'Musica Criolla ', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Crll/refs/heads/main/C.lla.json' }],
  'Disco': [{ name: 'Italo disco', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Dic..c/refs/heads/main/Idisco.json' }],
  'huaynos': [{ name: 'huaynos', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Hyns/refs/heads/main/hyn.json' }],
  'wwe': [{ name: 'Vintage (ingles)', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/w.3/refs/heads/main/w.w3.json' }],
  'Reguet√≥n': [{ name: 'Clasicos del Regueton', url: 'https://raw.githubusercontent.com/refinadorlegendary-rgb/Rgmp/refs/heads/main/rgtnnns.json' }]
};

// SOLUCI√ìN: CARGA INSTANT√ÅNEA SIN PARPADEO
function loadTrack(i, t = 0) {
    if (isSwitching || i === idx) return;
    
    isSwitching = true;
    const item = FILTERED_PLAYLIST[i];
    if (!item || !item.video) {
        isSwitching = false;
        return;
    }

    idx = i;
    
    // GUARDAR ESTADO ACTUAL
    const wasPlaying = !vP.paused;
    const currentTime = vP.currentTime;
    
    // CAMBIO INSTANT√ÅNEO - SIN RECARGAR EL VIDEO
    vP.src = item.video;
    
    // REPRODUCIR INMEDIATAMENTE
    vP.currentTime = t;
    
    const playPromise = vP.play();
    if (playPromise !== undefined) {
        playPromise.catch(e => {
            console.log('Autoplay bloqueado, esperando interacci√≥n');
            isSwitching = false;
        });
    }
    
    // ACTUALIZAR UI INMEDIATAMENTE
    renderList();
    localStorage.setItem('carIdx', idx);
    
    // RESETEAR FLAG DESPU√âS DE PEQUE√ëO RETRASO
    setTimeout(() => {
        isSwitching = false;
    }, 100);
}

// FUNCIONES B√ÅSICAS OPTIMIZADAS
function nextTrack() {
    loadTrack((idx + 1) % FILTERED_PLAYLIST.length);
}

function prevTrack() {
    loadTrack((idx - 1 + FILTERED_PLAYLIST.length) % FILTERED_PLAYLIST.length);
}

function filterByGenre(genre) {
    currentGenre = genre;
    FILTERED_PLAYLIST = genre === 'all' ? [...PLAYLIST] : PLAYLIST.filter(track => track.genre === genre);
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.genre === genre));
    
    if (idx >= FILTERED_PLAYLIST.length) idx = 0;
    renderList();
    if (FILTERED_PLAYLIST.length > 0) loadTrack(idx);
}

function renderList() {
    center.innerHTML = '';
    const countInfo = document.createElement('div');
    countInfo.style.padding = '1vh';
    countInfo.style.fontSize = '2.5vh';
    countInfo.style.color = 'var(--accent)';
    countInfo.textContent = `Mostrando ${FILTERED_PLAYLIST.length} canciones${currentGenre !== 'all' ? ` de ${currentGenre}` : ''}`;
    center.appendChild(countInfo);
    
    FILTERED_PLAYLIST.forEach((tr, i) => {
        const d = document.createElement('div');
        d.className = 'track' + (i === idx ? ' active' : '');
        d.innerHTML = `
            <img src="${tr.thumb}" onerror="this.src='https://picsum.photos/320/180?random=${i}'">
            <div class="track-info">
                <div class="track-title">${tr.title}</div>
                <div class="track-genre">${tr.genre} ‚Ä¢ ${tr.folder}</div>
            </div>
        `;
        d.onclick = () => loadTrack(i);
        center.appendChild(d);
    });
    
    setTimeout(() => {
        const activeTrack = center.querySelector('.track.active');
        if (activeTrack) activeTrack.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 50);
}

function createGenreFilters() {
    const allBtn = document.querySelector('.filter-btn[data-genre="all"]');
    allBtn.onclick = () => filterByGenre('all');
    const uniqueGenres = [...new Set(PLAYLIST.map(track => track.genre))];
    uniqueGenres.forEach(genre => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.dataset.genre = genre;
        btn.textContent = `${genre} (${PLAYLIST.filter(t => t.genre === genre).length})`;
        btn.onclick = () => filterByGenre(genre);
        filtersContainer.appendChild(btn);
    });
}

// SISTEMA DE PANTALLA COMPLETA CON UN SOLO VIDEO
function enterFullscreen() {
    if (isFullscreen) return;
    
    const originalParent = vP.parentNode;
    fullscreenContainer.appendChild(vP);
    
    vP.style.width = '100%';
    vP.style.height = '100%';
    vP.style.objectFit = 'contain';
    
    fullscreenContainer.classList.add('active');
    
    const elem = fullscreenContainer;
    if (elem.requestFullscreen) {
        elem.requestFullscreen().catch(e => console.log('Fullscreen no permitido'));
    } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
    }
    
    isFullscreen = true;
    vP.play().catch(e => console.log('Video continuando en fullscreen'));
    showControlsTemporarily();
}

function exitFullscreen() {
    if (!isFullscreen) return;
    
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
    }
    
    const originalPanel = document.querySelector('.panel');
    if (originalPanel) {
        const h3 = originalPanel.querySelector('h3');
        originalPanel.innerHTML = '';
        if (h3) originalPanel.appendChild(h3);
        originalPanel.appendChild(vP);
    }
    
    vP.style.width = '';
    vP.style.height = '';
    vP.style.objectFit = 'cover';
    
    fullscreenContainer.classList.remove('active');
    isFullscreen = false;
    
    setTimeout(() => {
        vP.play().catch(e => console.log('Video continuando en modo normal'));
    }, 50);
}

// FUNCIONES AUXILIARES
function toggleMute() {
    isMuted = !isMuted;
    vP.muted = isMuted;
    localStorage.setItem('carMuted', isMuted);
    updateMuteButton();
}

function updateMuteButton() {
    const muteBtn = document.getElementById('toggleMute');
    const fsMuteBtn = document.getElementById('fs-mute');
    muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
    if (fsMuteBtn) fsMuteBtn.textContent = isMuted ? 'üîá' : 'üîä';
}

function updateFullscreenControls() {
    const fsPlayBtn = document.getElementById('fs-play');
    if (fsPlayBtn) fsPlayBtn.textContent = vP.paused ? '‚ñ∂' : '‚óºÔ∏è';
}

function updateProgressBar() {
    if (vP.duration && !isNaN(vP.duration)) {
        bar.style.width = (100 * vP.currentTime / vP.duration) + '%';
    }
}

function hideControlsAfterDelay() {
    clearTimeout(controlsTimeout);
    const controls = document.getElementById('fullscreen-controls');
    if (controls && fullscreenContainer.classList.contains('active')) {
        controlsTimeout = setTimeout(() => controls.style.opacity = '0', 2000);
    }
}

function showControlsTemporarily() {
    const controls = document.getElementById('fullscreen-controls');
    if (controls) {
        controls.style.opacity = '1';
        hideControlsAfterDelay();
    }
}

// DETECCI√ìN DE CAMBIOS DE FULLSCREEN
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);

function handleFullscreenChange() {
    const isCurrentlyFullscreen = !!(
        document.fullscreenElement ||
        document.webkitFullscreenElement
    );
    
    if (isFullscreen && !isCurrentlyFullscreen) {
        exitFullscreen();
    }
}

// CARGA DE DATOS OPTIMIZADA
async function parseJSON(content, genre, folderName) {
    try {
        const data = JSON.parse(content);
        return data.map((item, index) => ({
            title: item.nombre || item.name || item.title || item.titulo || (typeof item === 'string' ? item : `Canci√≥n ${index + 1}`),
            video: item.url || item.video || item.src || '',
            thumb: item.thumb || item.thumbnail || item.image || `https://picsum.photos/320/180?random=${Math.random()}`,
            genre,
            folder: folderName
        }));
    } catch (error) {
        console.error('Error parsing JSON:', error);
        return [];
    }
}

async function loadAllMusic() {
    loadingIndicator.style.display = 'block';
    
    const cachedPlaylist = DataCache.get('full_playlist');
    if(cachedPlaylist) {
        PLAYLIST = cachedPlaylist;
        loadingIndicator.style.display = 'none';
        init();
        return;
    }
    
    PLAYLIST = [];
    try {
        const genrePromises = Object.entries(GENRE_FOLDERS).map(async ([genre, folders]) => {
            for (const folder of folders) {
                try {
                    const cacheKey = `genre_${genre}_${folder.name}`;
                    const cachedData = DataCache.get(cacheKey);
                    
                    if(cachedData) {
                        PLAYLIST.push(...cachedData);
                        continue;
                    }
                    
                    const response = await fetch(folder.url);
                    const jsonContent = await response.text();
                    const songs = await parseJSON(jsonContent, genre, folder.name);
                    const validSongs = songs.filter(song => song.video && song.video.startsWith('http'));
                    
                    if (validSongs.length > 0) {
                        PLAYLIST.push(...validSongs);
                        DataCache.set(cacheKey, validSongs);
                    }
                    
                } catch (error) {
                    console.error(`Error cargando ${folder.name}:`, error);
                }
            }
        });
        
        await Promise.all(genrePromises);
        DataCache.set('full_playlist', PLAYLIST);
        
    } finally {
        loadingIndicator.style.display = 'none';
        init();
    }
}

// INICIALIZACI√ìN
function init() {
    createGenreFilters();
    filterByGenre('all');
    
    vP.muted = isMuted;
    vP.ontimeupdate = updateProgressBar;
    vP.onplay = () => {
        document.getElementById('play').textContent = '‚óºÔ∏è';
        updateFullscreenControls();
    };
    vP.onpause = () => {
        document.getElementById('play').textContent = '‚ñ∂';
        updateFullscreenControls();
    };
    vP.onended = () => nextTrack();
    
    if (FILTERED_PLAYLIST.length > 0) loadTrack(idx);
    updateMuteButton();
}

// ASIGNAR EVENTOS
document.getElementById('play').onclick = () => {
    if (vP.paused) {
        vP.play();
        document.getElementById('play').textContent = '‚óºÔ∏è';
    } else {
        vP.pause();
        document.getElementById('play').textContent = '‚ñ∂';
    }
    updateFullscreenControls();
};

document.getElementById('next').onclick = nextTrack;
document.getElementById('prev').onclick = prevTrack;
document.getElementById('toggleMute').onclick = toggleMute;
document.getElementById('fullscreen').onclick = enterFullscreen;
drivingChk.onchange = () => {
    const drv = drivingChk.checked;
    if (drv) {
        document.body.classList.add('audio-only');
    } else {
        document.body.classList.remove('audio-only');
    }
};

// Controles de pantalla completa
document.getElementById('fs-prev').onclick = (e) => { prevTrack(); showControlsTemporarily(); e.stopPropagation(); };
document.getElementById('fs-next').onclick = (e) => { nextTrack(); showControlsTemporarily(); e.stopPropagation(); };
document.getElementById('fs-play').onclick = (e) => {
    if (vP.paused) vP.play(); else vP.pause();
    updateFullscreenControls();
    showControlsTemporarily();
    e.stopPropagation();
};
document.getElementById('fs-mute').onclick = (e) => { toggleMute(); showControlsTemporarily(); e.stopPropagation(); };
document.getElementById('fs-exit').onclick = (e) => { exitFullscreen(); e.stopPropagation(); };

fullscreenContainer.addEventListener('click', showControlsTemporarily);
fullscreenContainer.addEventListener('mousemove', showControlsTemporarily);

document.getElementById('progress').onclick = e => {
    const r = e.currentTarget.getBoundingClientRect();
    const pct = (e.clientX - r.left) / r.width;
    if (vP.duration && !isNaN(vP.duration)) vP.currentTime = pct * vP.duration;
};

setInterval(updateProgressBar, 500);

// INICIAR CARGA
loadAllMusic();
</script>
</body>
</html>
